' EBBS-PC Userfile Maint Program - UFMAINT
' Deletes old EBBS-PC userfiles and the users old email
' Started: 02-20-1993
' Updated: 09-25-1993
' Ed Parry

$CPU 8086
$FLOAT EMULATE
$OPTIMIZE SIZE

'*** INIT VARS ***
DEFINT A-Z

CR$=CHR$(13)+CHR$(10)
SP$=CHR$(32)
TRUE=-1
FALSE=NOT TRUE
KILLED.FILES=0
LAST.KILLED=0
KILL.DAYS=VAL(COMMAND$)
IF KILL.DAYS=0 THEN KILL.DAYS=120 '4 MONTHS DEFAULT
FOR I=1 TO 50:DUMMY$=DUMMY$+CR$+SP$:NEXT

OPEN "SORTUF.FLG" FOR OUTPUT AS #1 'SORT UFILE AFTER RUNNING THIS
CLOSE #1

GOSUB INIT.TEXT.WINDOW
GOSUB UPDATE.TEXT

ON ERROR GOTO ERROR.HANDLER

'*** OPEN USERFILE FOR MAINT ***
OPEN "USERFILE.DAT" FOR RANDOM AS #1 LEN=512
USERS=LOF(1)\512 'GET TOTAL USERFILES
FOR INDEX=1 TO USERS 'CHECK ALL USERFILES
 GET #1,INDEX 'POINT TO EACH RECORD
  FOR FIELDS=1 TO 11 'GET LAST CALL DATE
   INPUT#1,LAST.CALL$
   INPUT#1,TOTAL.CALLS&
  NEXT
 IF LEN(LAST.CALL$) > 6 THEN GOSUB NUM.DATE 'non-empty userfile
GOSUB UPDATE.TEXT

NEXT
CLOSE #1
END

NUM.DATE: 'CONVERTS LAST.CALL DATE to YYMMDD
'convert MM-DD-YY format to YYMMDD format
 A$=RIGHT$(LAST.CALL$,2)  'YEAR
 B$=MID$(LAST.CALL$,4,2)  'DAY
 C$=LEFT$(LAST.CALL$,2)   'MONTH
're concat numeric month
 MONTH$=A$+C$+B$ 'last call YYMMDD date
 GOSUB FIX.DATE  'current date YYMMDD date
'figure how many days since last call
 YR=VAL(LEFT$(DA$,2))-VAL(LEFT$(MONTH$,2))
 MN=(VAL(MID$(DA$,3,2))-VAL(MID$(MONTH$,3,2)))+MF
 IF MN<0 THEN MN=12 + MN:YR=YR-1
 DY=(VAL(RIGHT$(DA$,2))-VAL(RIGHT$(MONTH$,2)))
 IF DY<0 THEN DY=30 + DY:IF MN THEN MN=MN-1
 DAYS.OFF=(YR*365)+(MN*30)+DY
 'kill userfiles greater than our req'd call days
 IF KILL.DAYS =< DAYS.OFF THEN GOSUB KILL.USERFILE
 'dump off 1 call looky loo's - IE: 1 call only in 30+ days = del ufile
 IF (TOTAL.CALLS&=1) AND (DAYS.OFF>30) THEN GOSUB KILL.USERFILE
RETURN

FIX.DATE: 'CONVERTS CURRENT DATE MM-DD-YYYY TO YYMMDD
 DA$=RIGHT$(DATE$,2)+LEFT$(DATE$,2)+MID$(DATE$,4,2)
RETURN

KILL.USERFILE: 'FOUND AN OLD USERFILE TO DELETE
 LAST.KILLED=INDEX
 KILLED.FILES=KILLED.FILES+1
 PRINT #1," ":PUT #1,INDEX
 PRINT #1,DUMMY$:PUT #1,INDEX
 A$=RIGHT$("000"+MID$(STR$(INDEX),2),4)+".*"
 'PRINT A$
 KILL ".\EMAIL\"+A$ 'KILL EMAIL ALSO
RETURN

INIT.TEXT.WINDOW:
 CLS
 COLOR 1,15
 LOCATE 4
 LOCATE ,19:PRINT  "旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커"
 LOCATE ,19:PRINT  "  EBBS-PC USERFILE MAINTENANCE MODULE   "
 LOCATE ,19:PRINT  "쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑"
 LOCATE ,19:PRINT  " Delete Userfile > Days     :           "
 LOCATE ,19:PRINT  " Total Userfiles to Scan    :           "
 LOCATE ,19:PRINT  " Currently Scanning Userfile:           "
 LOCATE ,19:PRINT  " Last Userfile Deleted:     :           "
 LOCATE ,19:PRINT  " Total Userfiles Deleted:   :           "
 LOCATE ,19:PRINT  "읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸"
RETURN

UPDATE.TEXT: 'UPDATE WINDOW INFO
 LOCATE 7,49:PRINT KILL.DAYS;
 LOCATE 8,49:PRINT USERS;
 LOCATE 9,49:PRINT INDEX;
 LOCATE 10,49:PRINT LAST.KILLED;
 LOCATE 11,49:PRINT KILLED.FILES
RETURN

ERROR.HANDLER:
 OOPS=ERR
 IF OOPS=53 THEN RESUME NEXT
 LOCATE 15,12
 PRINT "PLEASE REPORT ERROR #"OOPS"IN THE EBBS-PC MAINT MODULE. - Ep"
 BEEP
END
